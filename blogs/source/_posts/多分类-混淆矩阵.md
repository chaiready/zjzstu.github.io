---
title: '[多分类]混淆矩阵'
categories:
  - - 算法
    - 评价标准
    - 混淆矩阵
  - - 编程
    - 代码库
  - - 编程
    - 编程语言
tags:
  - sklearn
  - python
abbrlink: c35edb41
date: 2020-01-11 15:34:56
---

参考：[[二分类]混淆矩阵](https://www.zhujian.tech/posts/74ea027a.html)

学习多分类任务的混淆矩阵计算，共有两种方式：

1. `one VS rest`
2. `one VS one`

## one VS rest

指定其中一个类别为正样本，将其他类别统统归类为负样本，然后进行混淆矩阵的计算

### python

`sklearn`提供了实现函数：[sklearn.metrics.multilabel_confusion_matrix](https://scikit-learn.org/stable/modules/generated/sklearn.metrics.multilabel_confusion_matrix.html?highlight=multilabel_confusion_matrix#sklearn-metrics-multilabel-confusion-matrix)

```
def multilabel_confusion_matrix(y_true, y_pred, sample_weight=None, labels=None, samplewise=False):
```

* `y_true`：一维数组（仅输出正样本标签）或者多维矩阵（`n_samples, n_outputs`）
* `y_pred`：和`y_true`的格式一样
* `labels`：列表形式，指定正样本的顺序，否则函数将按排序顺序进行计算

该函数计算基于每个类别的混淆矩阵，输出大小为`(n_outputs, 2, 2)`，每个混淆矩阵的排列如下：

|  TN   |  FP   |
| :---: | :---: |
|  FN   |  TP   |

### 示例

对`3`类任务进行计算，输入标签如下：

```
['cat', 'ant', 'cat', 'cat', 'ant', 'bird']
```

预测标签如下：

```
['ant', 'ant', 'cat', 'cat', 'ant', 'cat']
```

计算每类的混淆矩阵，并指定计算顺序：

```
res = multilabel_confusion_matrix(y_true, y_pred, labels=["ant", "bird", "cat"])
```

输出大小为`(3, 2, 2)`

```
[[[3 1]
  [0 2]]

 [[5 0]
  [1 0]]

 [[2 1]
  [1 2]]]
```

## one VS one

在多分类任务中，还可以对每两个类别进行混淆矩阵的计算

### python

`sklearn`提供了实现函数：[sklearn.metrics.confusion_matrix](https://scikit-learn.org/stable/modules/generated/sklearn.metrics.confusion_matrix.html#sklearn.metrics.confusion_matrix)

```
def confusion_matrix(y_true, y_pred, labels=None, sample_weight=None):
```

* `y_true`：一维数组，指定正样本
* `y_pred`：一维数组，输出预测标签
* `labels`：指定正样本顺序

函数返回一个`(n_classes, n_classes)`大小的混淆矩阵

### 示例

如果是二分类，其混淆矩阵排列为：

|  TN   |  FP   |
| :---: | :---: |
|  FN   |  TP   |

```
from sklearn.metrics import confusion_matrix

if __name__ == '__main__':
    tn, fp, fn, tp = confusion_matrix([0, 1, 0, 1], [1, 1, 1, 0]).ravel()
    print(tn, fp, fn, tp)
# 输出
0 2 1 1
```

如果是多分类，其输出如下：

```
from sklearn.metrics import confusion_matrix

if __name__ == '__main__':
    y_true = ["cat", "ant", "cat", "cat", "ant", "bird"]
    y_pred = ["ant", "ant", "cat", "cat", "ant", "cat"]
    res = confusion_matrix(y_true, y_pred, labels=["ant", "bird", "cat"])
    print(res)
# 输出
[[2 0 0]
 [0 0 1]
 [1 0 2]]
```

* 点$(i,i)$的值表示第$i$类正确分类的数目
* 点$(i,j)$的值表示第$i$类错误分类为$j$类的数目

## 利用混淆矩阵查看错误分类

参考：[分类算法-3.多分类中的混淆矩阵](https://www.cnblogs.com/shuai-long/p/11649896.html)

利用`one vs one`的方式计算多分类任务，能够理清具体的错误分类场景

### 数据集

参考[Fashion-MNIST数据集解析](https://www.zhujian.tech/posts/631c599a.html)

### 分类器

参考[神经网络分类器](https://www.zhujian.tech/posts/81a57a7.html)

### 实现

```
# -*- coding: utf-8 -*-

"""
@author: zj
@file:   confusion-matrix.py
@time:   2020-01-11
"""

from nn_classifier import NN
from mnist_reader import load_mnist
import numpy as np
import cv2
from sklearn.metrics import confusion_matrix
import matplotlib.pyplot as plt


def load_data():
    path = "/home/zj/data/fashion-mnist/fashion-mnist/data/fashion/"
    train_images, train_labels = load_mnist(path, kind='train')
    test_images, test_labels = load_mnist(path, kind='t10k')

    return train_images, train_labels, test_images, test_labels


if __name__ == '__main__':
    train_images, train_labels, test_images, test_labels = load_data()
    print(train_images.shape)
    print(train_labels.shape)

    x_train = train_images.astype(np.float64)
    x_test = test_images.astype(np.float64)
    mu = np.mean(x_train, axis=0)
    var = np.var(x_train, axis=0)
    eps = 1e-8
    x_train = (x_train - mu) / np.sqrt(np.maximum(var, eps))
    x_test = (x_test - mu) / np.sqrt(np.maximum(var, eps))

    classifier = NN([100, 20], input_dim=28 * 28, num_classes=10)
    classifier.train(x_train, train_labels, verbose=True)
    y_pred = classifier.predict(x_test)

    cm = confusion_matrix(test_labels, y_pred)
    print(cm)

    plt.matshow(cm)
    plt.show()
```

使用神经网络分类`Fashion-MNIST`，结果如下：

```
[[852   1  21  25   4   0  86   0  11   0]
 [  7 967   3  16   5   0   1   0   1   0]
 [ 25   1 833  12  70   1  55   0   3   0]
 [ 38   5  14 888  30   2  20   0   3   0]
 [  6   1 118  44 776   1  52   0   2   0]
 [  0   0   0   0   1 955   0  23   2  19]
 [167   1  93  38  75   4 608   0  14   0]
 [  0   0   0   0   0  28   0 921   0  51]
 [ 12   2   2   8   5   7  12   3 948   1]
 [  0   0   1   0   0  14   1  16   0 968]]
```

![](/imgs/multi-cm/cm-mnist.png)

从混淆矩阵中可以发现，标签`0`（就是`T`恤）最容易错误分类为标签`6`（就是衬衫）；标签`4`（就是外套）最容易错误分类为标签`２`（就是套衫）