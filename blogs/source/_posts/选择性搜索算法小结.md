---
title: 选择性搜索算法小结
categories:
  - - 随笔
  - - 算法
    - 机器学习
  - - 算法
    - 图像处理
tags:
  - 选择性搜索
  - 基于图的图像分割
  - 目标检测
  - 目标分割
abbrlink: 58ff6dae
date: 2020-02-21 11:19:55
---

研究了好久的选择性搜索算法，终于把它搞定!!!

## 论文

选择性搜索算法的实现包含了两部分，一是图分割算法，二是选择性搜索算法，分别由两篇论文组成：

1. [[译]高效的基于图的图像分割](https://zhujian.tech/posts/44a20d07.html)
2. [[译]作用于目标识别的选择性搜索](https://zhujian.tech/posts/1cb6a408.html)

## 源码

### 图分割

图分割论文提供了`C++`实现，同时`OpenCV`也实现了图分割算法

1. [基于图的图像分割-工程源码](https://zhujian.tech/posts/a4b1a6d9.html)
2. [基于图的图像分割-OpenCV源码](https://zhujian.tech/posts/18052054.html)

![](/imgs/选择性搜索小结/graphseg.png)

### 选择性搜索

选择性搜索算法在`OpenCV`中已有实现。为了进一步理解选择性搜索算法的实现，从`OpenCV`中抽取了相应的源码进行学习：[zjZSTU/selectivesearch](https://github.com/zjZSTU/selectivesearch)

![](/imgs/选择性搜索小结/selectivesearch.png)

![](/imgs/选择性搜索小结/selectivesearchsegmentationstrategy.png)

## OpenCV bug

当前使用`OpenCV 4.2.0`，之前使用过`OpenCV 4.0.0/4.1.0`，发现使用`selectivesearch`进行目标检测时，如果输入的图像长宽比过大就会出错。在`Github`的`opencv/opencv_contrib`仓库的`Issues`上找到不少的讨论

* [Bug in SelectiveSearchSegmentation #705](https://github.com/opencv/opencv_contrib/issues/705)
* [SelectiveSearchSegmentation crashes with some image #1707](https://github.com/opencv/opencv_contrib/issues/1707)
* [Selective Search crashes on images with a width:height or height:width ratio greater than about 2.43 #2102](https://github.com/opencv/opencv_contrib/issues/2102)

这个问题已经得到了解决：

* [Added a fix for issue 2102. #2103](https://github.com/opencv/opencv_contrib/pull/2103)
* [Fix 2102 redux #2132](https://github.com/opencv/opencv_contrib/pull/2132)

其原因是计算方向导数时，需要对图像进行旋转操作，计算梯度后重新旋转回原来的方向，并进行剪切操作。如果图像宽高比过大，会导致裁剪出错

```
During one of the stages of selective search, the image is rotated 45 degrees and gradients are computed along the X and Y directions in the rotated image. The gradient image is then rotated back to the original orientation and cropped to remove surrounding empty space, leaving it with the same shape as the original image. However, the implementation of the crop will specify an ROI with negative x or y values if the image's native aspect ratio is too high or too low (basically, if the image is far from square).

This is because the bounding box of the rotated image is strictly bigger than the original image if the original is sufficiently close to square; but if the original is too "skinny", the bounding box of its rotation will be less tall or wide than the original.

The fix is to threshold the x and y computed for the ROI at 0.
```

## 小结

选择性搜索算法将目标检测转换成图像分割

* 图分割算法将图像分割的过程转换成图分量合并的过程
* 选择性搜索算法对初始分割集进行分层分组算法，进一步合并得到更多的候选区域