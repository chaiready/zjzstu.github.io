<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="alternate" href="/./atom.xml" title="做一个幸福的人" type="application/atom+xml"><meta name="google-site-verification" content="Qr_3yqLtyErDFKHW7mE8PJz4qDUX-bf_fMLpSRckQe4"><meta name="baidu-site-verification" content="zOwIvKMV7f"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Roboto:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-center-atom.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"7.5.0",exturl:!1,sidebar:{position:"left",display:"post",offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"搜索文章",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},translation:{copy_button:"复制",copy_success:"复制成功",copy_failure:"复制失败"},sidebarPadding:40}</script><link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto&display=swap" rel="stylesheet"><meta name="description" content="参考：CS231n课程笔记翻译：神经网络笔记3（上）CS231n课程笔记翻译：最优化笔记（下）通过数值梯度（numerical gradient）和解析梯度（analytic gradient）的比较进行梯度检查，这个过程有助于得到更准确的网络"><meta name="keywords" content="python,numpy,梯度检查"><meta property="og:type" content="article"><meta property="og:title" content="梯度检查"><meta property="og:url" content="https:&#x2F;&#x2F;www.zhujian.tech&#x2F;posts&#x2F;d91a1c6f.html"><meta property="og:site_name" content="做一个幸福的人"><meta property="og:description" content="参考：CS231n课程笔记翻译：神经网络笔记3（上）CS231n课程笔记翻译：最优化笔记（下）通过数值梯度（numerical gradient）和解析梯度（analytic gradient）的比较进行梯度检查，这个过程有助于得到更准确的网络"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2020-02-15T05:36:35.875Z"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.zhujian.tech/posts/d91a1c6f.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,isPage:!1,isArchive:!1}</script><title>梯度检查 | 做一个幸福的人</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?e677aac1ac69b8826b9cfecb4e72e107";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">做一个幸福的人</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">面朝大海，春暖花开</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签<span class="badge">129</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类<span class="badge">48</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档<span class="badge">169</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header> <a href="https://github.com/zjZSTU" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zhujian.tech/posts/d91a1c6f.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="zhujian"><meta itemprop="description" content="one bite at a time"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="做一个幸福的人"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 梯度检查</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-08-01 20:56:03" itemprop="dateCreated datePublished" datetime="2019-08-01T20:56:03+00:00">2019-08-01</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-02-15 05:36:35" itemprop="dateModified" datetime="2020-02-15T05:36:35+00:00">2020-02-15</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/algorithm/" itemprop="url" rel="index"><span itemprop="name">算法</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">编程</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/algorithm/optimization/" itemprop="url" rel="index"><span itemprop="name">最优化</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/programming/programming-language/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/programming/codebase/" itemprop="url" rel="index"><span itemprop="name">代码库</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.1k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>参考：</p><p><a href="https://zhuanlan.zhihu.com/p/21741716?refer=intelligentunit" target="_blank" rel="noopener">CS231n课程笔记翻译：神经网络笔记3（上）</a></p><p><a href="https://zhuanlan.zhihu.com/p/21387326" target="_blank" rel="noopener">CS231n课程笔记翻译：最优化笔记（下）</a></p><p>通过数值梯度（<code>numerical gradient</code>）和解析梯度（<code>analytic gradient</code>）的比较进行梯度检查，这个过程有助于得到更准确的网络</p><a id="more"></a><p>学习<a href="http://cs231n.github.io/neural-networks-3/" target="_blank" rel="noopener">Gradient checks</a>中提到的技巧和注意事项</p><h2 id="中心差分"><a href="#中心差分" class="headerlink" title="中心差分"></a>中心差分</h2><p>使用中心差分公式（<code>the centered difference formula</code>）能够更好的计算数值梯度</p><script type="math/tex;mode=display">
\frac {df(x)}{dx}
=\frac {f(x+h) - f(x-h)}{2h}</script><p>步长$h$是一个极小值，当前取值为$1e^{-5}$</p><h2 id="相对误差比较"><a href="#相对误差比较" class="headerlink" title="相对误差比较"></a>相对误差比较</h2><p>计算数值梯度$f_{n}’$和解析梯度$f_{a}’$的相对误差，同时除以其中最大值以消除量纲，最后得到的值能够有一个统一的评判标准</p><script type="math/tex;mode=display">
\frac {|f_{n}' - f_{a}'|}{\max (|f_{n}'|, |f_{a}'|, 1e^{-8})}</script><p>使用$max$以及$1e^{-8}$是为了避免最大值为$0$以及两个值均为$0$的情况</p><h2 id="评判标准"><a href="#评判标准" class="headerlink" title="评判标准"></a>评判标准</h2><ul><li>相对误差大于$1e^{-2}$通常意味着梯度可能是错误的</li><li>相对误差在$[1e^{-2}, 1e^{-4}]$之间同样不太准确</li><li>相对误差小于$1e^{-4}$，如果目标存在扭结（<code>kinks</code>），比如<code>tanh</code>非线性或者<code>softmax</code>，那么这个结果是可以接受的；否则，$1e^{-4}$仍然太高</li><li>相对误差小于$1e^{-7}$是最好的结果</li></ul><p>深度网络的相对误差变得更大，所以对于<code>10</code>层网络而言，其相对误差小于$1e^{-2}$可能就很好了，因为误差在传递过程中累积；相反，对于单个可微函数而言，$1e^{-2}$表明梯度不正确</p><h2 id="使用双精度"><a href="#使用双精度" class="headerlink" title="使用双精度"></a>使用双精度</h2><p>使用双精度（<code>double precision</code>）数据进行梯度检查能够得到更准确的相对误差</p><h2 id="保持浮点数有效范围"><a href="#保持浮点数有效范围" class="headerlink" title="保持浮点数有效范围"></a>保持浮点数有效范围</h2><p>参考：<a href="http://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html" target="_blank" rel="noopener">What Every Computer Scientist Should Know About Floating-Point Arithmetic</a></p><p>在梯度计算过程中，如果梯度的有效范围（<em>大部分梯度的取值</em>）太小，会造成更多的数值问题（<code>numerical issues</code>）</p><p>可以通过打印原始数值/解析梯度的方式查看，也可以通过<code>IDE</code>调试工具进行查看。如果数值梯度过小，比如取值在$1e^{-10}$左右甚至更小，可以通过放大损失函数值进行调整，理想情况下在$1.0$的数量级，即浮点数的指数为$0$</p><h2 id="目标中的扭结"><a href="#目标中的扭结" class="headerlink" title="目标中的扭结"></a>目标中的扭结</h2><p>相对误差过大的一个原因在于扭结（<code>kink</code>）的问题，扭结是指目标函数的不可微部分（<code>non-differentiable parts</code>），比如<code>ReLU</code>函数在$x=0$点</p><p>假定输入数据$x=-1e^{-6}$，因为<code>x</code>小于<code>0</code>，所以该点的解析梯度为<code>0</code>，然而如果$h&gt;1e^{-6}$，那么$f(x+h)&gt;0$，数值梯度大于<code>0</code>，会得到一个较大的相对误差</p><p>查找是否出现扭结需要追踪所有激活函数$\max(x,y)$中<code>winner</code>的身份，比如在前向计算中$x$或者$y$的值更大，但是在$f(x+h)$或$f(x-h)$的计算中<code>winner</code>身份发生了改变，那么表明出现了扭结现象</p><p>一种解决技巧是使用少量的数据点进行测试，降低发生扭结的可能性</p><h2 id="谨慎设置步长h"><a href="#谨慎设置步长h" class="headerlink" title="谨慎设置步长h"></a>谨慎设置步长h</h2><p>参考：<a href="https://en.wikipedia.org/wiki/Numerical_differentiation" target="_blank" rel="noopener">Numerical differentiation</a></p><p>步长$h$不一定是越小越好，因为过小的步长有可能会产生数值精度问题。当梯度无法检查时，可以尝试改变步长为$1e^{-4}$或$1e^{-6}$</p><h2 id="Gradcheck-during-a-“characteristic”-mode-of-operation"><a href="#Gradcheck-during-a-“characteristic”-mode-of-operation" class="headerlink" title="Gradcheck during a “characteristic” mode of operation"></a>Gradcheck during a “characteristic” mode of operation</h2><p>使用随机参数对网络进行梯度检查可能会引入病理边缘病例，并掩盖梯度的错误实现，也就是梯度看起来正确实现了，但实际上并没有</p><p>最好先训练一段时间，在损失值开始下降后再进行梯度检查，更能够保证网络的准确性</p><h2 id="不要让正则化项影响数据"><a href="#不要让正则化项影响数据" class="headerlink" title="不要让正则化项影响数据"></a>不要让正则化项影响数据</h2><p>损失函数包括数据损失以及正则化损失，如果正则化损失比数据损失大，那么主要的梯度将来自于正则化项，这会掩盖数据丢失梯度的错误实现</p><p>所以梯度检查时可以先单独检查数据损失，再检查正则化损失。检查正则化损失的方式一方面可以去除数据损失相关代码，另一方面可以提高正则化强度，使正则化梯度无法被忽略</p><h2 id="关闭随机失活-数据扩充"><a href="#关闭随机失活-数据扩充" class="headerlink" title="关闭随机失活/数据扩充"></a>关闭随机失活/数据扩充</h2><p>执行梯度检查的过程中，应该关闭网络中任何非确定性（<code>non-deterministic</code>）的影响，比如随机失活（<code>dropout</code>）、随机数据扩充（<code>random data augmentation</code>），因为在计算数值梯度时，这些参数会明显的带来巨大的误差</p><p>关闭操作会导致无法梯度检查这些参数，一种更好的解决方案是在计算$f(x+h)$和$f(x-h)$过程中设置特定的随机数种子</p><h2 id="检查少量维度"><a href="#检查少量维度" class="headerlink" title="检查少量维度"></a>检查少量维度</h2><p>实际操作中网络存在上百万的参数，这种情况下只能假设大部分参数是正确的，仅检查少数参数，<strong>特别注意的是</strong>确保在不同参数的某些维度进行梯度检查</p><h2 id="python实现"><a href="#python实现" class="headerlink" title="python实现"></a>python实现</h2><p>在<code>cs231n</code>课程的课后作业<code>assignment</code>中已实现了数值梯度计算 - <a href="https://github.com/zjZSTU/cs231n/blob/master/assignment1/cs231n/gradient_check.py" target="_blank" rel="noopener">gradient_check.py</a>，主要操作的是前两个函数：</p><blockquote><p>def eval_numerical_gradient(f, x, verbose=True, h=0.00001):<br>def eval_numerical_gradient_array(f, x, df, h=1e-5):</p></blockquote><ul><li>参数$f$表示待检查的方法/类/网络</li><li>参数$x$表示输入数据</li><li>参数$df$表示反向传播中回传的梯度</li></ul><p>两者均采用中心差分公式计算数值梯度，区别在于前一个函数的$f$输出值是单个数值，而后者$f$的输出值可以是数组</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line"># @Time    : 19-8-1 下午7:40</span><br><span class="line"># @Author  : zj</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import numpy as np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def eval_numerical_gradient(f, x, verbose=True, h=0.00001):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    a naive implementation of numerical gradient of f at x</span><br><span class="line">    - f should be a function that takes a single argument</span><br><span class="line">    - x is the point (numpy array) to evaluate the gradient at</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    fx = f(x)  # evaluate function value at original point</span><br><span class="line">    grad = np.zeros_like(x)</span><br><span class="line">    # iterate over all indexes in x</span><br><span class="line">    it = np.nditer(x, flags=[&apos;multi_index&apos;], op_flags=[&apos;readwrite&apos;])</span><br><span class="line">    while not it.finished:</span><br><span class="line"></span><br><span class="line">        # evaluate function at x+h</span><br><span class="line">        ix = it.multi_index</span><br><span class="line">        oldval = x[ix]</span><br><span class="line">        x[ix] = oldval + h  # increment by h</span><br><span class="line">        fxph = f(x)  # evalute f(x + h)</span><br><span class="line">        x[ix] = oldval - h</span><br><span class="line">        fxmh = f(x)  # evaluate f(x - h)</span><br><span class="line">        x[ix] = oldval  # restore</span><br><span class="line"></span><br><span class="line">        # compute the partial derivative with centered formula</span><br><span class="line">        grad[ix] = (fxph - fxmh) / (2 * h)  # the slope</span><br><span class="line">        if verbose:</span><br><span class="line">            print(ix, grad[ix])</span><br><span class="line">        it.iternext()  # step to next dimension</span><br><span class="line"></span><br><span class="line">    return grad</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def eval_numerical_gradient_array(f, x, df, h=1e-5):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Evaluate a numeric gradient for a function that accepts a numpy</span><br><span class="line">    array and returns a numpy array.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    grad = np.zeros_like(x)</span><br><span class="line">    it = np.nditer(x, flags=[&apos;multi_index&apos;], op_flags=[&apos;readwrite&apos;])</span><br><span class="line">    while not it.finished:</span><br><span class="line">        ix = it.multi_index</span><br><span class="line"></span><br><span class="line">        oldval = x[ix]</span><br><span class="line">        x[ix] = oldval + h</span><br><span class="line">        pos = f(x).copy()</span><br><span class="line">        x[ix] = oldval - h</span><br><span class="line">        neg = f(x).copy()</span><br><span class="line">        x[ix] = oldval</span><br><span class="line"></span><br><span class="line">        grad[ix] = np.sum((pos - neg) * df) / (2 * h)</span><br><span class="line">        it.iternext()</span><br><span class="line">    return grad</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def compute_value(x):</span><br><span class="line">    return np.sum(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def compute_value_array(x):</span><br><span class="line">    return x + x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    x = np.arange(9., dtype=np.double).reshape(3, 3)</span><br><span class="line"></span><br><span class="line">    grad = eval_numerical_gradient(compute_value, x, verbose=False)</span><br><span class="line">    print(grad)</span><br><span class="line"></span><br><span class="line">    grad = eval_numerical_gradient_array(compute_value_array, x, 1)</span><br><span class="line">    print(grad)</span><br></pre></td></tr></table></figure><p>参考<code>cs231n</code>实现了全连接神经网络：<a href="https://github.com/zjZSTU/cs231n/blob/master/coding/classifier/nn_classifier.py" target="_blank" rel="noopener">nn_classifier.py</a>，包含了全连接以及<code>ReLU</code>层的前后向运算，神经网络配置、训练及预测功能</p><p>同时实现了全连接神经网络的测试文件：<a href="https://github.com/zjZSTU/cs231n/blob/master/coding/tests/test_nn_classifier.py" target="_blank" rel="noopener">test_nn_classifier.py</a>，里面包含了对全连接操作、<code>ReLU</code>操作、<code>softmax</code>损失操作以及<code>2</code>层和<code>3</code>层网络的测试</p></div><div class="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div> <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';"> 打赏</button><div id="qr" style="display:none"><div style="display:inline-block"> <img src="/images/wechatpay.jpg" alt="zhujian 微信支付"><p>微信支付</p></div><div style="display:inline-block"> <img src="/images/alipay.jpg" alt="zhujian 支付宝"><p>支付宝</p></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> zhujian</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.zhujian.tech/posts/d91a1c6f.html" title="梯度检查">https://www.zhujian.tech/posts/d91a1c6f.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/python/" rel="tag"># python</a> <a href="/tags/numpy/" rel="tag"># numpy</a> <a href="/tags/gradient-check/" rel="tag"># 梯度检查</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/cef93ee3.html" rel="next" title="单元测试"><i class="fa fa-chevron-left"></i> 单元测试</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/posts/869619ac.html" rel="prev" title="合理性检查">合理性检查<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments" id="gitalk-container"></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#中心差分"><span class="nav-number">1.</span> <span class="nav-text">中心差分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相对误差比较"><span class="nav-number">2.</span> <span class="nav-text">相对误差比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#评判标准"><span class="nav-number">3.</span> <span class="nav-text">评判标准</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用双精度"><span class="nav-number">4.</span> <span class="nav-text">使用双精度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#保持浮点数有效范围"><span class="nav-number">5.</span> <span class="nav-text">保持浮点数有效范围</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目标中的扭结"><span class="nav-number">6.</span> <span class="nav-text">目标中的扭结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#谨慎设置步长h"><span class="nav-number">7.</span> <span class="nav-text">谨慎设置步长h</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gradcheck-during-a-“characteristic”-mode-of-operation"><span class="nav-number">8.</span> <span class="nav-text">Gradcheck during a “characteristic” mode of operation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#不要让正则化项影响数据"><span class="nav-number">9.</span> <span class="nav-text">不要让正则化项影响数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭随机失活-数据扩充"><span class="nav-number">10.</span> <span class="nav-text">关闭随机失活/数据扩充</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查少量维度"><span class="nav-number">11.</span> <span class="nav-text">检查少量维度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#python实现"><span class="nav-number">12.</span> <span class="nav-text">python实现</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="zhujian" src="/images/avatar.png"><p class="site-author-name" itemprop="name">zhujian</p><div class="site-description" itemprop="description">one bite at a time</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">169</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">48</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">129</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="feed-link motion-element"><a href="/./atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zjZSTU" title="Github &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;zjZSTU" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a></span><span class="links-of-author-item"><a href="https://blog.csdn.net/u012005313" title="CSDN &amp;rarr; https:&#x2F;&#x2F;blog.csdn.net&#x2F;u012005313" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i> CSDN</a></span><span class="links-of-author-item"><a href="/mailto:zjzstu@gmail.com" title="Gmail &amp;rarr; mailto:zjzstu@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> Gmail</a></span><span class="links-of-author-item"><a href="/mailto:505169307@gmail.com" title="QQmail &amp;rarr; mailto:505169307@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> QQmail</a></span></div><div class="cc-license motion-element" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://cloud.tencent.com/" title="https:&#x2F;&#x2F;cloud.tencent.com" rel="noopener" target="_blank">腾讯云</a></li><li class="links-of-blogroll-item"> <a href="https://www.aliyun.com/" title="https:&#x2F;&#x2F;www.aliyun.com" rel="noopener" target="_blank">阿里云</a></li><li class="links-of-blogroll-item"> <a href="https://developer.android.com/" title="https:&#x2F;&#x2F;developer.android.com&#x2F;" rel="noopener" target="_blank">Android Dev</a></li><li class="links-of-blogroll-item"> <a href="https://jenkins.io/" title="https:&#x2F;&#x2F;jenkins.io&#x2F;" rel="noopener" target="_blank">Jenkins</a></li><li class="links-of-blogroll-item"> <a href="http://cs231n.github.io/" title="http:&#x2F;&#x2F;cs231n.github.io&#x2F;" rel="noopener" target="_blank">cs231n</a></li><li class="links-of-blogroll-item"> <a href="https://pytorch.org/docs/stable/index.html" title="https:&#x2F;&#x2F;pytorch.org&#x2F;docs&#x2F;stable&#x2F;index.html" rel="noopener" target="_blank">pytorch</a></li><li class="links-of-blogroll-item"> <a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" title="https:&#x2F;&#x2F;docs.docker.com&#x2F;install&#x2F;linux&#x2F;docker-ce&#x2F;ubuntu&#x2F;" rel="noopener" target="_blank">docker</a></li></ul></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">zhujian</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">948k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">26:20</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-bar-chart-o"></i></span> <a href="https://tongji.baidu.com/web/27249108/overview/index?siteId=13647183" rel="noopener" target="_blank">百度统计</a></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0</div> <span class="post-meta-divider">|</span><div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0</div><div class="beian"> <a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备 19026415号</a> <span class="post-meta-divider">|</span> <img src="/images/beian_icon.png" style="display:inline-block;text-decoration:none;height:13px"> <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33011802001748" rel="noopener" target="_blank">浙公网安备 33011802001748号</a></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span> <span class="site-uv" title="总访客量">访客数：<span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="site-pv" title="总访问量">阅读量：<span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="17,63,61" opacity="1" zindex="-1" count="199" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script><script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '8f22595c6dd29c94467d',
      clientSecret: 'e66bd90ebb9aa66c562c753dec6c90ceecbd51f2',
      repo: 'guestbook',
      owner: 'zjZSTU',
      admin: ['zjZSTU'],
      id: '1293a7923e21c0df24702994a983bbb8',
        language: '',
      distractionFreeMode: 'true'
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
</script></body></html>